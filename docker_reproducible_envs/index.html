<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Reprodiucible Environments with Docker</title>
	<link rel="icon" type="image/ico" href="./favicon.ico" />

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/dist/reveal.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/dist/reset.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/dist/theme/black.min.css" id=theme>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css"
		integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w=="
		crossorigin="anonymous" />

	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/plugin/highlight/monokai.min.css"
		id="highlight-theme">
	<style>
		.console {
			background: #444455;
			color: #eeeeff;
			font-family: monospace;
			/* height: 120px; */
			margin-top: 20px;
			margin-bottom: 2rem;
			padding: 24px;
			border-radius: 8px;
			box-shadow: 5px 5px 15px 7px rgba(30, 144, 255, 0.4);
			text-align: start;
			font-size: 1.5rem;
		}

		.text-file {
			background: black;
			color: chartreuse;
			font-family: monospace;
			/* height: 120px; */
			margin-top: 20px;
			margin-bottom: 2rem;
			padding: 24px;
			border-radius: 8px;
			box-shadow: 5px 5px 15px 7px rgba(161, 251, 77, 0.4);
			text-align: start;
			font-size: 1.5rem;
		}

		.ps {
			color: dodgerblue;
		}

		.alert {
			position: relative;
			padding: 0.75rem 1.25rem;
			margin-bottom: 1rem;
			border: 1px solid transparent;
			border-radius: 0.25rem;
			font-size: 1.5rem;
		}

		.alert-info {
			color: #3a87ad;
			background-color: #d9edf7;
			border-color: #bce8f1;
		}

		li>ul {
			font-size: 1.75rem;
		}
	</style>
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<h3>
					Reproducible Environments with Docker
				</h3>
				<h4>
					Wesley Banfield
				</h4>
				<i class="fab fa-docker fa-3x" style="color: #498FDF;"></i>
			</section>
			<section>
				<h3>
					Plan
				</h3>
				<ol>
					<li>
						The need for reproducible computing
					</li>
					<li>
						What is Docker?
					</li>
					<li>
						Running your first container
					</li>
					<li>
						Building your first container
					</li>
					<li>
						Publishing your container
					</li>
					<li>
						Using Volumes
					</li>
					<li>
						Using Docker Compose
					</li>
					<li>
						Best Practices
					</li>
					<li>
						Creating a Github Repository
					</li>
					<li>
						Alternatives
					</li>
				</ol>
			</section>
			<section>
				<section>
					<h3>
						The need for reproducible computing
					</h3>
				</section>
				<section>
					<div>
						<img
							src="https://media.springernature.com/w300/springer-static/image/art%3A10.1038%2F533452a/MediaObjects/41586_2016_Article_BF533452a_Figg_HTML.jpg?as=webp" />
						</br>
						<p style="text-align: center;font-size: 1.5rem;">
							<a href="https://www.nature.com/articles/533452a">Baker 2016, Nature</a>
						</p>
					</div>
				</section>
				<section>
					<h4>
						How can we distribute code?
					</h4>
					<ul>
						<li>
							scripts, notebooks, NbViewer
						</li>
						<li>
							Github, Bitbucket, GitLab, etc.
						</li>
					</ul>

					<h4 style="margin-top: 2em;">
						Difficulties
					</h4>
					<ul>
						<li>
							Read Only / Cached Version / Can't change data
						</li>
						<li>
							Variations in code environment → different results or crashes
						</li>
						<li>
							Code version in repo different to current version → Not the same as article
						</li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h3>
						What is Docker?
					</h3>
					<ul>
						<li>
							Docker is a containerization (virtualisation) tool
						</li>
						<li>
							Think of it as a virtual machine
						</li>
						<li>
							Docker has :
							<ul>
								<li>
									<b>images</b>: equivalent to an iso used to create a virtual machine for instance
								</li>
								<li>
									<b>containers</b>: and instance of an image, multiple containers can be based/run of
									from the same image
								</li>
							</ul>
						</li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Running your first container
					</h3>
				</section>
				<section>
					<div class="console">
						<span class="ps">$</span>
						docker run -i -t ubuntu /bin/bash
					</div>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Building your first container
					</h3>
				</section>
				<section>
					<h4>
						Create a notebook
					</h4>
					In this example we are going to use a dummy notebook to show how to create reprodiucible figures.
					Please bear in mind that this is only a demo you can do the same steps with other notebooks OR code.

					<p>
						Download the following notebook locally: <a
							href='https://github.com/WesleyTheGeolien/Presentations/raw/main/docker_reproducible_envs/demo_notebook.ipynb'>Click
							to Download</a> and put it into a src folder.
					</p>
				</section>
				<section>
					<h4>
						Data
					</h4>
					<p>
						Download the following data locally: <a
							href='https://github.com/WesleyTheGeolien/Presentations/raw/main/docker_reproducible_envs/paleotopo.nc'>Click
							to Download</a> and put it into a Data Folder
					</p>
				</section>
				<section>
					<h4>
						Specifying the environment
					</h4>
					<p>
						Look inside the notebook and find the external libraries. Put these into a requirements.txt
						file.
					</p>
					<div class="text-file">
						hvplot==0.7.0
						</br>
						xarray==0.16.2
						</br>
					</div>
					<div class="alert alert-info">
						In the file above we are only "freezing" the libraries we use and not their dependancies.
						</br>
						Be as specific as possible with the versions
					</div>
				</section>
				<section>
					<h4>
						Specifying the environment
					</h4>
					<div class="alert alert-info">
						This "freezes" everything in the environment even libraries that aren't used, it can cause
						problems if certain packages are no longer available.
					</div>
					<div class="console">
						<span class="ps">$</span>
						pip freeze > requirements.txt
						</br>
						<span class="ps">$</span>
						conda list --export > spec-file.txt
						</br>
						<span class="ps">$</span>
						conda env export > environment.yml
					</div>
				</section>
				<section>
					<h4>
						Recreating the environment
					</h4>
					<div class="console">
						<span class="ps">$</span>
						pip install -r requirements.txt
						</br>
						<span class="ps">$</span>
						conda create --name myenv --file spec-file.txt
						</br>
						<span class="ps">$</span>
						conda env create -f environment.yml
					</div>
				</section>
				<section>
					<h4>
						Additional Files
					</h4>
					<ul>
						<li>
							README.md
						</li>
						<li>
							<a href="https://choosealicense.com">License</a>
						</li>
					</ul>
				</section>
				<section>
					<h4>
						Creating the Dockerfile - Choosing the base image
					</h4>
					<img src="https://jupyter-docker-stacks.readthedocs.io/en/latest/_images/inherit.svg"
						style="background-color: white;height: 55vh;" class="fragment">
					<div class='text-file fragment'>
						FROM jupyter/scipy-notebook
					</div>
				</section>
				<section>
					<h4>
						Creating the Dockerfile - Copying Data
					</h4>
					<div class='text-file'>
						COPY Data /home/jovyan/work/data
						</br>
						COPY requirements.txt /home/jovyan/work/requirements.txt
						</br>
						COPY demo_notebook /home/jovyan/work/
					</div>
				</section>
				<section>
					<h4>
						Recreating the environment
					</h4>
					<div class="console">
						<span class="ps">$</span>
						pip install -r requirements.txt
						</br>
						<span class="ps">$</span>
						conda create --name myenv --file spec-file.txt
						</br>
						<span class="ps">$</span>
						conda env create -f environment.yml
					</div>
				</section>
				<section>
					<h4>
						Putting it all together
					</h4>
					<div class='text-file'>
						FROM jupyter/scipy-notebook
						</br>
						COPY requirements.txt /home/jovyan/work/requirements.txt
						</br>
						RUN pip install -r /home/jovyan/work/requirements.txt
						</br>
						COPY demo_notebook.ipynb /home/jovyan/work/
						</br>
						COPY Data /home/jovyan/work/data
						</br>
					</div>
					<div class="alert alert-info">
						Each Command is a "layer" for quick development place code that doesn't change towards the start
						of the file
					</div>
				</section>
				<section>
					<h4>
						Building the image
					</h4>
					<div class="console">
						<span class="ps">$</span>
						docker build -t my-notebook .
					</div>
				</section>
				<section>
					<h4>
						Running the image
					</h4>
					<div class="console">
						<span class="ps">$</span>
						docker run -it -p 8888:8888 my-notebook
					</div>
					<div class="alert alert-info">
						We use -it to run the container interactively
					</div>
					<div class="alert alert-info">
						We use -p to bind the jupyter port to the host port 8888
					</div>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Publishing the image
					</h3>
				</section>
				<section>
					<h4>
						DockerHub
					</h4>
					<ul>
						<li>
							Create a Docker Hub account
						</li>
						<li>
							Optionally create a Docker Hub Organization (ceregecl exists) <a
								href="https://hub.docker.com/orgs">Orgs page</a>
						</li>
						<li>
							tag the image with org/image-name if organization else leave it as is
						</li>
						<li>
							<div class="console">
								<span class="ps">$</span>
								docker push YOUR_IMAGE_NAME
							</div>
						</li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Using Volumes (advanced)
					</h3>
					<p>
						A Volume is a directory that can be shared between containers and the host (think of it as a USB
						plugged into a
						Virtual Machine).
					</p>

					<h4 style="text-align: start;">
						Uses
					</h4>
					<ul>
						<li>
							Containers aren't persistent so this can be used to save data to the local harddrive (think
							figures)
						</li>
						<li>
							You can load new data into the container by copying it to the volume
						</li>
					</ul>
				</section>
				<section>
					<div class="console">
						<span class="ps">$</span>
						docker run -it -p 8888:8888 -v $PWD/results:/home/jovyan/work/results my-notebook
					</div>
					<div class="alert alert-info">
						Local paths need to be full absolute paths (we use $PWD to get local directory)
					</div>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Using Docker Compose
					</h3>
					One file to build all the containers (if multiple) and hold run commands
				</section>
				<section>
					<textarea class="text-file">
						version: '2'
						</br>
						    services:
						</br>
								my-notebook:
						</br>
									build: .
						</br>
									ports:
						</br>
									- 8888:8888
					</div>
				</section>
				<seciton>
					<div class="console">
						<span class="ps">$</span>
						docker-compose up --build 
					</div>
				</seciton>
			</section>
			<section>
				<section>
					<h3>
						Best Practices
					</h3>
				</section>
				<section>
					<ul>
						<li>
							Link to Repository directly and obtain a DOI for the repository.
						</li>
						<li>
							Publish the image to a Docker Hub repository and provide link.
						</li>
						<li>
							<strong>
								Organize your research
							</strong>
							<ul style="columns: 2;">
								<li>
									Code
								</li>
								<li>
									Notebooks
								</li>
								<li>
									Data
								</li>
								<li>
									Results
								</li>
								<li>
									License + Requirements + Dockerfile + README.md
								</li>
							</ul>
						</li>
					</ul>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Creating a Github Repository
					</h3>
					<ul>
						<li>
							Go to <a href="https://www.github.com">github.com</a>
						</li>
						<li>
							Top right click on the plugin
							<div style="display: flex; justify-content: center;">
								<img src="new_repo.png" style="height: 20vh;">
							</div>
						</li>
						<li>
							Choose a name
						</li>
						<li>
							Add Readme
						</li>
						<li>
							Choose a License
						</li>
						<li>
							Click Create Repository
						</li>
					</ul>
				</section>
				<section>
					<h3>
						Working locally
					</h3>
					<div class="console">
						<span class="ps">$</span>
						git clone https://github.com/YOUR_USERNAME/YOUR_REPONAME.git
					</div>
					<div class="alert alert-info">
						This can also be found on the repository website under the code button
						<div style="display: flex; justify-content: center;">
							<img src="clone.png" style="height: 20vh;">
						</div>
					</div>
					Make local changes then to see the changes:
					<div class="console">
						<span class="ps">$</span>
						git status
					</div>
				</section>
				<section>
					To add all the local changes
					<div class="console">
						<span class="ps">$</span>
						git add *
					</div>
					To create a commit
					<div class="console">
						<span class="ps">$</span>
						git commit -m "YOUR COMMIT MESSAGE"
					</div>
					To push to the remote repository (update the server)
					<div class="console">
						<span class="ps">$</span>
						git push
					</div>
				</section>
			</section>
			<section>
				<section>
					<h3>
						Alternatives
					</h3>
					<ul>
						<li>
							MyBinder
						</li>
						<li>
							Code Ocean - <a
								href='https://docs.google.com/presentation/d/17h_ylV84m_AY6-0uhYxFcI59nsiYoev4nTESUvoFlrA/edit?usp=sharing'>Workshop
								JupyterCon 2018 April Clyburne-Sherin, Code Ocean</a>
						</li>
					</ul>
				</section>
			</section>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/plugin/markdown/markdown.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/dist/reveal.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/plugin/notes/notes.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/reveal.js@4.0.2/plugin/highlight/highlight.min.js"></script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,
			// autoSlide: 1500,
			// loop: true,

			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
		});
	</script>
</body>

</html>